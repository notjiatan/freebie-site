---
/**
 * Homepage Entry Layout
 *
 * Main landing page layout with all homepage sections:
 * - Hero/Banner with proof & testimonials
 * - Featured services carousel
 * - How it works
 * - What we offer
 * - Pricing tiers
 * - Stats
 */
import BaseLayout from "@components/base/BaseLayout.astro";
import { markdownify } from "@lib/textConverter";
import Button from "@components/common/Button.astro";
import Footer from "@components/base/Footer.astro";
import PricingTable from "@components/common/PricingTable.astro";
import HomepageTOC from "@components/common/HomepageTOC.astro";
import type { HomeEntry } from "@/types";
import { getIndex } from "@lib/contentParser";

interface Props {
  entry: HomeEntry;
}

const { entry } = Astro.props;
const { logoPath, title, content, button } = entry.data;

// Load "What We Offer" content from markdown
const whatWeOfferEntry = await getIndex("what-we-offer");
const { title: offerTitle, description: offerDesc, offerings } = whatWeOfferEntry.data;
---

<BaseLayout>
  <!-- Homepage Table of Contents -->
  <HomepageTOC />

  <!-- Hero Banner with Proof & Testimonials -->
  <section class="section" id="proof-testimonials">
    <div class="container">
      <div class="row justify-center">
        <div class="text-center lg:col-6">
          <!-- Logo/Image -->
          {logoPath && (
            <div class="blur-[0px]">
              <img
                class="mb-6 w-64 svg-glow mx-auto"
                src={logoPath}
                alt={title}
                width={256}
                height={256}
                loading="eager"
              />
            </div>
          )}

          <!-- Hero Title and Subtitle -->
          <h1 set:html={markdownify(title)} class="mb-4 flicker-text neon-title" />
          <p set:html={markdownify(content)} class="mb-8 neon-subtitle" />

          <!-- Proof & Testimonials Button and Iframe -->
          {button && (
            <>
              <div class="mb-4">
                <h2 class="section-title">Proof & Testimonials</h2>
              </div>
              <Button
                label={button.label}
                link={button.link}
                newtab
                hoverInvert
                color=""
              />
              <div class="mt-8 iframe-container">
                <div class="iframe-loading">Loading...</div>
                <iframe
                  style="width: 100%; max-width: 800px; height: 400px; border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px;"
                  title="Stoat Chat"
                ></iframe>
              </div>
            </>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Services Carousel -->
  <section class="section" id="featured-services">
    <div class="container">
      <div class="row justify-center">
        <div class="text-center mb-4">
          <h2 class="section-title">Featured Services</h2>
        </div>
        <div class="text-center mb-8">
          <Button
            label="View ALL Our Services & Freebies (WE HAVE DOZENS)"
            link="#"
            hoverInvert
            color=""
          />
        </div>

        <!-- Horizontal Scrolling Carousel -->
        <div class="col-12">
          <div class="carousel" mask>
            <!-- Service: Greggs -->
            <article>
              <img src="https://images.unsplash.com/photo-1555507036-ab1f4038808a?w=1260&h=750&fit=crop" alt="Greggs bakery and food">
              <h2>Greggs</h2>
              <div>
                <p>Get free items, meal deals, and exclusive vouchers from the UK's favorite bakery chain.</p>
              </div>
            </article>

            <!-- Service: Apple Music -->
            <article>
              <img src="https://images.unsplash.com/photo-1511379938547-c1f69419868d?w=1260&h=750&fit=crop" alt="Apple Music streaming">
              <h2>Apple Music</h2>
              <div>
                <p>Access premium Apple Music subscriptions and extended free trials for unlimited music streaming.</p>
              </div>
            </article>

            <!-- Service: Amazon Prime -->
            <article>
              <img src="https://images.unsplash.com/photo-1523474253046-8cd2748b5fd2?w=1260&h=750&fit=crop" alt="Amazon Prime delivery and streaming">
              <h2>Amazon Prime</h2>
              <div>
                <p>Unlock Amazon Prime membership benefits including free shipping, Prime Video, and exclusive deals.</p>
              </div>
            </article>

            <!-- Service: Uber Eats -->
            <article>
              <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=1260&h=750&fit=crop" alt="Uber Eats food delivery">
              <h2>Uber Eats</h2>
              <div>
                <p>Score free delivery vouchers, promotional codes, and meal discounts from Uber Eats.</p>
              </div>
            </article>

            <!-- Service: Nandos -->
            <article>
              <img src="https://images.unsplash.com/photo-1598103442097-8b74394b95c6?w=1260&h=750&fit=crop" alt="Nandos restaurant food">
              <h2>Nandos</h2>
              <div>
                <p>Get free Nando's meals, loyalty rewards, and exclusive dining vouchers for your favorite peri-peri chicken.</p>
              </div>
            </article>

            <!-- Service: McDonalds -->
            <article>
              <img src="https://images.unsplash.com/photo-1619454016518-697bc231e7cb?w=1260&h=750&fit=crop" alt="McDonald's fast food">
              <h2>McDonald's</h2>
              <div>
                <p>Access free McDonald's vouchers, app deals, and exclusive promotions for your favorite fast food.</p>
              </div>
            </article>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- How It Works Section -->
  <section class="section" id="how-it-works">
    <div class="container">
      <div class="row justify-center">
        <div class="text-center mb-12">
          <h2 class="section-title">How It Works</h2>
        </div>
      </div>

      <div class="row justify-center">
        <div class="col-12">
          <div class="how-it-works-wrapper">
            <!-- Vertical scroll indicator with animated line and circle -->
            <div class="scroll-indicator">
              <div class="scroll-line"></div>
              <div class="scroll-fill"></div>
              <div class="scroll-circle"></div>
            </div>

            <!-- Step-by-step process -->
            <div class="steps-container">
              <!-- Step 1: Sign Up -->
              <div class="step-item">
                <div class="step-content">
                  <div class="step-image">
                    <img src="/assets/how-it-works/signup.png" alt="Sign-Up" loading="lazy" />
                  </div>
                  <div class="step-text">
                    <h3 class="step-title">Step 1 — Sign-Up</h3>
                    <p class="step-description"></p>
                  </div>
                </div>
              </div>

              <!-- Step 2: Browse -->
              <div class="step-item">
                <div class="step-content">
                  <div class="step-image">
                    <img src="/assets/how-it-works/services.png" alt="Browse freebies" loading="lazy" />
                  </div>
                  <div class="step-text">
                    <h3 class="step-title">Step 2 — Browse Available Freebies</h3>
                    <p class="step-description">Explore hundreds of free items, subscriptions, and exclusive deals</p>
                  </div>
                </div>
              </div>

              <!-- Step 3: Generate -->
              <div class="step-item">
                <div class="step-content">
                  <div class="step-image">
                    <img src="/assets/how-it-works/generate.png" alt="Claim rewards" loading="lazy" />
                  </div>
                  <div class="step-text">
                    <h3 class="step-title">Step 3 — Generate The Freebies You Want</h3>
                    <p class="step-description">Follow the simple instructions in the chat app to generate your freebies.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- What We Offer Section -->
  <section class="section" id="what-we-offer">
    <div class="container">
      <div class="row justify-center">
        <div class="text-center mb-12">
          <h2 class="section-title">{offerTitle}</h2>
          {offerDesc && <p class="text-lg neon-subtitle opacity-80 mt-4">{offerDesc}</p>}
        </div>
      </div>

      <!-- Grid of offering cards -->
      <div class="row justify-center">
        <div class="col-12">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {offerings.map((offering) => (
              <div class="offering-card">
                <div class="offering-card-content">
                  <h3 class="offering-card-title">{offering.title}</h3>
                  <p class="offering-card-description" set:html={offering.description} />

                  <!-- Brand Icons -->
                  {offering.brandIcons && offering.brandIcons.length > 0 && (
                    <div class="offering-brand-icons">
                      {offering.brandIcons.map((iconUrl) => {
                        const isMoreBadge = iconUrl.includes('more.svg');
                        return isMoreBadge ? (
                          <div class="more-badge-icon">
                            <span>10's more</span>
                          </div>
                        ) : (
                          <div class="brand-icon">
                            <img src={iconUrl} alt="Brand icon" />
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                <!-- Category Icon -->
                {offering.icon && (
                  <div class="offering-card-icon">
                    <img src={offering.icon} alt={offering.title} />
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Pricing Tiers Section -->
  <section class="section" id="tiers">
    <div class="container">
      <div class="row justify-center">
        <div class="text-center mb-4">
          <h2 class="section-title">Tiers</h2>
        </div>
        <PricingTable />
      </div>
    </div>
  </section>

  <!-- Our Stats Section -->
  <section class="section" id="our-stats">
    <div class="container">
      <div class="row justify-center">
        <div class="text-center mb-12">
          <h2 class="section-title">Our Stats</h2>
        </div>
      </div>

      <div class="row justify-center">
        <div class="col-12">
          <div class="stats-container">
            <!-- Community Member Count Widget -->
            <div class="stat-widget discord-widget">
              <div class="widget-header">
                <span class="widget-title">Freebie Finders Community Chat</span>
              </div>
              <div class="widget-stats">
                <div class="stat-row">
                  <div class="status-dot online"></div>
                  <span class="stat-label"><span class="stat-number">12,345</span> Online</span>
                </div>
                <div class="stat-row">
                  <div class="status-dot total"></div>
                  <span class="stat-label"><span class="stat-number">45,678</span> Members</span>
                </div>
              </div>
            </div>

            <!-- Premium Subscribers Widget -->
            <div class="stat-widget premium-widget">
              <div class="widget-header">
                <div class="premium-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                  </svg>
                </div>
                <span class="widget-title">Premium Members</span>
              </div>
              <div class="widget-stats">
                <div class="stat-row">
                  <div class="status-dot premium"></div>
                  <span class="stat-label"><span class="stat-number">1,233</span> Active Subscribers</span>
                </div>
              </div>
            </div>

            <!-- Staff Online Widget -->
            <div class="stat-widget staff-widget">
              <div class="widget-header">
                <div class="staff-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                </div>
                <span class="widget-title">Support Team</span>
              </div>
              <div class="widget-stats">
                <div class="stat-row">
                  <div class="status-dot online"></div>
                  <span class="stat-label"><span class="stat-number">5</span> Staff Online</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<Footer />

<script>
  /**
   * Animated scroll indicator for "How It Works" section
   * Creates a smooth, animated vertical line that follows scroll progress
   */
  function initScrollIndicator() {
    const wrapper = document.querySelector('.how-it-works-wrapper') as HTMLElement;
    if (!wrapper) return;

    const indicator = wrapper.querySelector('.scroll-indicator') as HTMLElement;
    const circle = wrapper.querySelector('.scroll-circle') as HTMLElement;
    const fill = wrapper.querySelector('.scroll-fill') as HTMLElement;

    if (!indicator || !circle || !fill) return;

    // Animation state
    let currentPos = 0;
    let targetPos = 0;
    const ease = 0.15; // Easing factor for smooth animation

    // Clamp value between min and max
    function clamp(val: number, min: number, max: number): number {
      return Math.max(min, Math.min(max, val));
    }

    // Update indicator position based on scroll
    function updateIndicator() {
      const rect = wrapper.getBoundingClientRect();
      const viewportMid = window.innerHeight / 2;

      // Calculate target position
      targetPos = clamp(viewportMid - rect.top, 0, rect.height);

      // Smooth interpolation
      currentPos += (targetPos - currentPos) * ease;

      // Apply transforms
      circle.style.top = `${currentPos}px`;
      fill.style.height = `${currentPos}px`;

      requestAnimationFrame(updateIndicator);
    }

    // Start animation loop
    updateIndicator();
  }

  // Initialize on page load and Astro page transitions
  document.addEventListener('DOMContentLoaded', initScrollIndicator);
  document.addEventListener('astro:page-load', initScrollIndicator);
</script>
